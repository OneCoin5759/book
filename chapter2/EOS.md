# EOS分享复盘

## 摘要

&emsp;&emsp;现有去中心化的系统大多有着交易速度慢、难以构建DAPP等局限，而EOS披着ethereum2.0的名头出现在人们眼前，让人不明觉里。在本次分享中，求知若渴的李老师将从EOS设计中的DPOS、账户/消息/权限、并行处理、token模型及资源使用、governance几个方面进行讲解，帮助大家更清楚地认识EOS到底是是一个什么OS。

## 分享动机

&emsp;&emsp;李老师这次分享的动机，总的来说是三个方面：对未知的恐惧、对知识的好奇、对真相的探求（看李老师觉悟多高！）。具体为以下几点：

1. EOS号称以太坊2.0,6月与ETH必有一战，李老师作为eth持有者，瑟瑟发抖；

2. EOS作为去中心化的系统，号称能支持每秒三十万次的交易；

3. EOS有巨大争议，比如他的中心化设计，他的经济学token模型不靠谱；

## EOS的诞生

- **BM其人（大家应该都知道，不知道就自行百度吧= =）**

- **现有区块链系统的问题**

- **EOS要达到的目的**

	1. Support Millions of users
	2. Free usage
	3. Easy upgrade and bug recovery
	4. Low latency
	5. Sequential performance
	6. Parallel performance
	
- **EOS的开发背景**

## DPOS

- **DPOS的简介**

	&emsp;&emsp;现有共识机制分为两大流派：工作量证明与权益证明，DPOS属于后者，委托授权的权益证明。

- **DPOS的过程**

	1. 投票阶段：有EOS token的都有投票权，连续投票选择出一定数量的区块生产者，每个人都有机会参与竞选，获得最多投票的获胜。
	2. 生产区块阶段：选出来的生产者随机轮流生产区块。

- **简单举例**

	&emsp;&emsp;假设群里这帮人每人有个账户，账户中有一定量的token，现在开始一轮DPOS过程。设N=3（即三个区块生产者），现在有4个账户要竞选生产者（老董、frank、班长小姐姐、李老师），每个人可以选择投自己想要投的人，而投票的权重则是自己token所占所有token的比例。投票可以包含不同的规则，这里可以规定每个人可以多投，但是投的人不能超过两个人。

	&emsp;&emsp;投票过程结束之后，老董、frank、班长小姐姐所得票数位居三甲，则他们被选入作为区块生产者，李老师贬为庶民，如下图所示。

	&emsp;&emsp;开始生产区块阶段。由于选出的生产者为老董、frank、班长小姐姐，则将他们shuffle一下，生成一个随机生产的顺序，然后每三个区块为一轮（N==3），生产者顺序生产区块，每一轮结束之后，shuffle一下继续生产。如下图所示。

	&emsp;&emsp;以上就是正常情况下，DPOS的工作流程。EOS的具体DPOS过程会稍有不同，如参数的不同，选举规则的不同等，但是万变不离其宗。

	&emsp;&emsp;DPOS定义最长链为共识链，在正常的情况下，所有21个区块生产者都正常参与区块的验证，因此1.5秒后则可以得到确认（这里李老师有个疑问，我也没想明白，大家一起讨论讨论吧）。

![](https://i.imgur.com/RZzZTdq.png)

![](https://i.imgur.com/wzw53lN.png)

- **异常情况及处理**

	&emsp;&emsp;异常情况：1. 恶意的区块生产者；2. 网络拥塞；3. 某个生产者宕机；4. 发生了fork。
	
	&emsp;&emsp;关于异常情况的处理和证明，这里不详细阐述，放一个链接大家可以学习学习：[DPOS异常情况的处理和证明](https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper) 。文章列出了七种情况，经过推演，最后的结论是：当少数生产者作恶的情况下，DPOS都在已知异常和攻击下是可靠的。即使多数生产者出现问题，社区也可以通过投票的方式取缔这些生产者。当然，虽然说是证明，这里证明的方式是举反证，因为可能还有例子没有举出来，所以这样的证明可能不太严谨。但是bitshares和steemit一直运行良好，只有姑且认为他是可靠地。

- **DPOS优势**

	1. 因为少量的生产者以协作的方式确定性地生产区块，所以产生的latency非常小，速度快；
	2. 区块生产者的存在给governance提供了机会，即主观产生共识。
	
	&emsp;&emsp;从bitshare和steemit实际工作的情况来看，DPOS确实带来了优异的性能，所以可以期待EOS也是一个吞吐量非常大的系统。
## 账户、消息、权限

- **账户**

	&emsp;&emsp;EOS提供账户这样一种设计或者功能。每个账户由2到32字符命名，每个账户都有自己私有的database，账户可以向其他账户发送定义好的结构化消息，这些消息由具体的消息处理函数处理。账户消息处理和code则组成了EOS的智能合约。

- **权限管理系统**

	&emsp;&emsp;EOS的账户里定义了一套基于角色权限的管理系统，用来判断消息是否符合用户定义的权限。用户可以通过自定义命名的权限等级，这些等级之间有继承的关系，父等级将拥有子等级的所有权限。

	&emsp;&emsp;同时，EOS里又有消息处理函数组的概念，每一个账户的消息可以用组进行分类，便于分配访问权限，这个有点类似namespace。在权限等级和消息处理函数之间，通过一种权限映射的方式来判断。

	&emsp;&emsp;总结一下，就是用户通过声明式的方法定义权限，在消息发送后，由EOS软件来检查权限，确定消息处理函数是否应该被调用。

	&emsp;&emsp;以下是EOS白皮书中权限映射的方式，具体的可以在白皮书里看，这里只是做一个展示。

![](https://i.imgur.com/OEBKCNI.png)

- **权限管理系统设计初衷**

	&emsp;&emsp;账户权限的功能为何不放在应用层，让账户自己来做，而是要放在底层，听起来像是一个非常糟糕的设计。如我们进行的solidity学习中多员工薪酬系统，onlyOwner就是一种权限管理。关于这一点EOS是这样解释的，把权限管理标准化，并从dapp中剥离出来，有两个好处：1.便于开发工具，用一种通用的方式来管理权限；2.提供了性能优化的空间。

	&emsp;&emsp;第一点有点虚，涉及到很多小点；第二点在EOS的白皮书里做了详细的解释。权限计算，是一种readonly的计算，这样意味着所有的权限验证可以并行进行，因为权限验证占了所有计算的很大一部分的比例，因此对这一部分的优化可以很大地提高性能。

	&emsp;&emsp;这个设计的本质，是因为任何消息处理函数都有权限验证的部分，这样设计可以对权限验证部分做单独的并行化处理，而如果交给用户货看开发者的code来做，是无法做到并行处理的。这里体现出EOS的一个特点，追求极致的性能。

- **私钥恢复机制**

	&emsp;&emsp;EOS账户的另一个特色，就是提供了一种恢复机制，处理私钥被盗的情况。账户的私钥一旦被盗，用户可以利用过去三十天内的active的ownerkey结合账户的partner来reset ownerkey。这里的关键是账户的partner，这里比如说邮件验证、短信验证之类来验证用户的身份。这里又体现出了EOS的另一个特点，从用户场景考虑做了一些很高级的功能。

## 并行执行

&emsp;&emsp;并行执行是EOS一个重要而有趣的地方。区块链的共识需要确定的行为，而EOS需要用并行处理来提高性能，这带来了很大的挑战。

- **要解决的问题**

	&emsp;&emsp;区块链共识，是依赖于一个确定的，可以reproduce的过程，那么一个节点，从第一个区块开始执行到第N个区块应该产生唯一的结果。换句话说，区块链系统是一个以区块为输入的确定状态机。

	&emsp;&emsp;EOS为了让DAPP大规模并发运行，需要引入horizontal skill的方法，那必然是某种multi-thread的解决方案。（注意这里的thread是thread of execution，而不是狭义中OS里的thread)

	&emsp;&emsp;EOS要采用这样一种设计，需要保证每个账户串行地处理消息，而在账户的粒度进行并行。

	&emsp;&emsp;同时EOS也要解决延时的问题，因为对于一个高性能的平台，延时很关键，EOS认为三秒的block时间对于消息延时是不可接受的，如果账户间需要来回发送消息，累积延时会非常长。

- **解决的方式**

	&emsp;&emsp;那针对上述问题，EOS对每个区块消息的级别进行了划分，设计了block、cycles、threads、transactions、messages、receiver and notified accounts这几个级别，他们的关系，以及数据处理方式都如下图所示。

	&emsp;&emsp;其中，一个cycle里有多个thread并行执行，这是EOS主要优化性能的地方，即一种horizontal-skill。EOS的消息是异步执行的，一个cycle里的代码发起消息，必须schedule到下一个cycle里执行。

	&emsp;&emsp;EOS用上述设计，来处理一致性和性能的问题。不难看出这里的关键问题是调度，把所有的消息安排到不同的thread里并行执行，在这里，这种调度就是21个被选出来的区块生产者的工作。区块生产者有很多种方案来产生这样一种调度，但是每种调度会产生唯一的执行结果。

	&emsp;&emsp;这里调度的约束也很简单，就是同一个账户里写状态message，不能再同一cycle的多个thread里执行。

![](https://i.imgur.com/L4ZOuS1.png)


- **其他并行优化的工作**

	&emsp;&emsp;EOS的并行优化，还做了一些其他的工作，比如对于只读的消息处理函数的并行优化处理（类权限管理）；比如对多消息多账户的原子操作处理等等。详见白皮书。

- **课堂作业**

	1. 我们说一个区块链必须可以replay，但是EOS引入了并行处理的概念，使得一个区块内的transaction可能在多个线程执行，为了达到 replay这个目的，上图中block、cycle、thread、transaction、meassage等信息，哪些必须记录在区块里呢？
	2. 写出一个最简单的调度算法的伪代码。

## 费用模型及资源使用

&emsp;&emsp;Token是区块链系统的重要组成部分，代表着区块链资源的使用权，从而决定了系统的资源分配，整个系统的资源分配都围绕token产生。不同的区块链系统对于使用权的设计是不同的，Ethereum和EOS的设计就正好相反。

- **ethereum与EOS费用模型的对比**

	&emsp;&emsp;ethereum是发起人支付费用（gas），EOS是接受方付费。eos的方式更符合现在的互联网的运行方式。即服务的使用方不需要付费，而接收者处理消息需要使用资源。

	&emsp;&emsp;接收方为了使用资源，需要持有一定量的token。EOS软件按照账户持有token的比例给账户分配资源。比如一个账户拥有所有token的百分之一，则他最多使用百分之一的RAM资源，如果想要更高比例的资源，则需要持有更高比例的token。

- **EOS资源的使用**

	&emsp;&emsp;EOS里的资源，包括：1.带宽、log存储，即网络和 block数据；2.计算资源，即CPU；3.状态存储，即RAM。

	&emsp;&emsp;对于资源的估计，是由21个区块生产者主观判断决定的。EOS提供了算法让区块生产者计算资源，但是区块生产者也可以选择自己的算法。

- **CryptoCatties举例**

	&emsp;&emsp;以风靡一时的以太猫为例。因为以太坊区块有gas limit，当以太猫的访问量非常大时，就会造成以太坊的拥堵，因为大家都在争抢资源。而如果运行在EOS上则不会有这样的问题，因为并非按照transaction的使用来设置limit，而以太猫的账户，最多只能使用持有token比例的带宽和计算资源。

- **课堂作业**

	&emsp;&emsp;对于DDOS攻击这种行为，以太坊上发生的现象，和EOS上发生的有什么不同，各会产生什么样的影响？

## governance

- **定义**

	&emsp;&emsp;通过人的主观判断，而不是用代码来达成的共识。

- **存在的原因**

	&emsp;&emsp;EOS认为，一个区块链系统需要governance的存在来处理一些情况，比如：软件的bug、严重的异常、软件的升级、系统参数的修改。

- **极大的权力**

	&emsp;&emsp;在EOS系统中，21个区块生产者拥有极大的权力，只要21个区块生产者中的17个达成共识，则可以做到以下一些事情，如：冻结某个账户、修改一个账户的代码等。由于区块生产者是动态的，如果他们滥用自己的权力，则会被社区投票出局。

- **EOS宪法机制**

	&emsp;&emsp;该机制不详细论述，详见白皮书 。

- **governance的利弊**

	利：快速响应。如ethereum当年的漏洞，如果快速反应冻结了行盗的账户，这不至于分叉。

	弊：不确定性。客观的代码可以带给我们安全感，区块生产者的主观判断和极大的权力会让我们队未来充满了不确定性。

## 总结

&emsp;&emsp;谦虚的李老师这次暂时没有对跨链处理、虚拟机设计进行讨论，欢迎同学们一起分享讨论！

- **目标的实现**

	1. Support Millions of users：通过EOS的高性能、高并发解决；
	2. Free usage：通过token模型解决，是向服务提供者收费；
	3. Easy upgrade and bug recovery：通过区块生产者governance实现；
	4. Low latency：利用EOS并行处理的设计以及DPOS的共识算法；
	5. Sequential performance：暂且没在白皮书中看到
	6. Parallel performance：通过thread进行一个horizontal的skill来解决。
	
- **EOS到底是个什么OS**

	&emsp;&emsp;首先，EOS的设计经验来源于以前的项目经验，包括DPOS的可靠性，至少有以前项目实践经验的背书。

	&emsp;&emsp;其次，EOS是一个追求极致性能的系统，为了性能不惜把一些上层的功能做进底层，比如权限处理。

	&emsp;&emsp;同时，EOS提供了一个相对比较完整的、更接近用户场景的设计，比如账户找回之类，可以看出EOS从用户的角度考虑了很多问题。

	&emsp;&emsp;总结起来就是四个字，实用主义。有一种设计哲学是少就是好，要做精简。能给上层做的，一定不留给底层，这样来提供更大的灵活性。但是EOS不惜把系统的功能做大做全，其目的，就是为了提供一个可用的系统，追求的就是实用。

## 附录

&emsp;&emsp;[DPOS相关证明](https://steemit.com/dpos/@dantheman/dpos-consensus-algorithm-this-missing-white-paper)

&emsp;&emsp;[EOS学习资料分享](https://github.com/washingweb/eos-resources)

&emsp;&emsp;[知乎网友对于EOS交易速度的讨论](https://www.zhihu.com/question/265927960)

## 作业汇总

1. 我们说一个区块链必须可以replay，但是EOS引入了并行处理的概念，使得一个区块内的transaction可能在多个线程执行，为了达到 replay这个目的，上图中block、cycle、thread、transaction、meassage等信息，哪些必须记录在区块里呢？
2. 写出一个最简单的调度算法的伪代码。
3. 对于DDOS攻击这种行为，以太坊上发生的现象，和EOS上发生的有什么不同，各会产生什么样的影响？